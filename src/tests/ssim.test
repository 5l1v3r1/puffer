#!/bin/bash -ex
# this is a hack
pwd="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ -z $test_tmpdir ];then
    test_tmpdir="test_tmp"
    mkdir -p $test_tmpdir
fi

TEST_VECTOR="test-vectors"

DAALA=$(pwd)/../../third_party/daala_tools
D_SSIM=dump_ssim
D_FSSIM=dump_fastssim
SSIM=$(pwd)/../ssim/ssim
FILE1=$TEST_VECTOR/"ssim/480p-to-720p.y4m"
FILE2=$TEST_VECTOR/"ssim/canonical-720p.y4m"
SOL1=$TEST_VECTOR/"ssim/sol.ssim"
SOL2=$TEST_VECTOR/"ssim/sol-n2.ssim"
OUTPUT1=$test_tmpdir/"out_ssim1"
OUTPUT2=$test_tmpdir/"out_ssim2"

# run the ssim test
$SSIM $FILE1 $FILE2 $OUTPUT1
result1=$(tail -n 1 $OUTPUT1)
truth1=$(tail -n 1 $SOL1)

# run the daala tools
if [ "$result1" != "$truth1" ]
then
    exit 1
fi

# test step size
$SSIM -n 2 $FILE1 $FILE2 $OUTPUT2
result2=$(tail -n 1 $OUTPUT2)
truth2=$(tail -n 1 $SOL2)

if [ "$result2" != "$truth2" ]
then
    exit 1
fi
